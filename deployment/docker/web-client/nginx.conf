# Nginx configuration for web client
# IMPORTANT: Serve static files (CSS, JS, images) from Nginx, JSP and servlets from Payara

server {
    listen 80;
    server_name _;
    
    # Root directory for static files
    root /usr/share/nginx/html;
    index index.html;
    
    # Increase max upload size (for video uploads)
    client_max_body_size 2G;
    client_body_buffer_size 128k;
    
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/html;

    # CRITICAL: Proxy JSP files FIRST (before static file serving)
    # This must come before any static file location blocks
    location ~ \.jsp$ {
        # If path doesn't start with practica5-web-client, add it
        rewrite ^/(?!practica5-web-client)(.*)$ /practica5-web-client/$1 break;
        proxy_pass http://rest-service:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # Serve static assets from practica5-web-client context (for Payara-rendered pages)
    # This handles paths like /practica5-web-client/css/style.css
    location ~ ^/practica5-web-client/(css|js|images|uploads|videos)/ {
        root /usr/share/nginx/html;
        expires 1y;
        add_header Cache-Control "public, immutable";
        # Remove the context prefix to find the file
        rewrite ^/practica5-web-client/(.*)$ /$1 break;
    }
    
    # Serve static assets by extension (CSS, JS, images) - but NOT JSP
    # JSP files are already handled above, so this won't match them
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|map)$ {
        root /usr/share/nginx/html;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Serve static directories (css/, js/, images/, etc.) from root
    location ~ ^/(css|js|images|uploads|videos)/ {
        root /usr/share/nginx/html;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Proxy API requests to REST service
    location /practica5-rest-service/ {
        proxy_pass http://rest-service:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy servlets to Payara (both with and without context)
    # Handle paths like /login and /practica5-web-client/login
    location ~ ^/(practica5-web-client/)?(login|logout|listVideo|listCourses|chat|viewNotes|createCourse|uploadVideo|playerVideo|player|deleteVideo|retryTranscode|registrarUsuario)$ {
        set $servlet_path $2;
        rewrite ^/(practica5-web-client/)?(.*)$ /practica5-web-client/$servlet_path break;
        proxy_pass http://rest-service:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    # Proxy everything else (JSP directories, other paths) to Payara
    location / {
        proxy_pass http://rest-service:8080/practica5-web-client/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Handle redirects properly - rewrite Location header to remove context path
        proxy_redirect http://$host/practica5-web-client/ http://$host/;
        proxy_redirect http://$host:8080/practica5-web-client/ http://$host/;
        proxy_redirect http://rest-service:8080/practica5-web-client/ http://$host/;
    }
}
